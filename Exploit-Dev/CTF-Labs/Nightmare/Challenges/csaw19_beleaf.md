# Csaw19 Beleaf

## Overview

Running the binary we see the following message: 

```bash
root-at-iyn@Ubuntu-220403-x86-64:~/Nightmare/Introduction/BeginnerRE$ ./beleaf 
Enter the flag
>>> 
```

After entering some dummy text in the prompt we get the response: 

```
Incorrect!
```

To get a better look at the binary I opened it up in gdb to check the disassembly:

```bash
Reading symbols from ./beleaf...
(No debugging symbols found in ./beleaf)
gefâž¤  disass main
No symbol table is loaded.  Use the "file" command.
```

From the response, it looks like the binary has built with no debugging symbols :(. We can see it appears as stripped when running the file command:

```bash
root-at-iyn@Ubuntu-220403-x86-64:~/Nightmare/Introduction/BeginnerRE$ file beleaf
beleaf: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=6d305eed7c9bebbaa60b67403a6c6f2b36de3ca4, stripped
```

## Reversing the binary

Now what? When I tried to run the binary in gdb I couldn't break on main becuase we are immediately in the scanf function's stack frame. I tried stepping over it and walking through it, but after you hit scanf's prompt for input, unless you provide the correct values the process will exit.

At this point I decided to see what I could find in Ghidra. I created a new project and started to code browser to inspect the beleaf binary. I got a prompt asking if I want Ghidra to auto analyse the binary and selected yes to this. After the auto analysis we see some functions Ghidra has been able to identify in the binary. If we select any one of these we the disassembly of assembly instructions in the left pane, and pseudo C code on the right. Since there are no debugging symbols Ghidra creates temporary names for functions and variables, however the logic of binary's execution shouldn't change.

After looking through the functions I find what looks like a `main` style function: 

```c
undefined8 FUN_001008a1(void)

{
  size_t sVar1;
  long lVar2;
  long in_FS_OFFSET;
  ulong local_b0;
  char local_98 [136];
  long local_10;

  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  printf("Enter the flag\n>>> ");
  __isoc99_scanf(&DAT_00100a78,local_98);
  sVar1 = strlen(local_98);
  if (sVar1 < 0x21) {
    puts("Incorrect!");
                    /* WARNING: Subroutine does not return */
    exit(1);
  }
  for (local_b0 = 0; local_b0 < sVar1; local_b0 = local_b0 + 1) {
    lVar2 = FUN_001007fa((int)local_98[local_b0]);
    if (lVar2 != *(long *)(&DAT_003014e0 + local_b0 * 8)) {
      puts("Incorrect!");
                    /* WARNING: Subroutine does not return */
      exit(1);
    }
  }
  puts("Correct!");
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    /* WARNING: Subroutine does not return */
    __stack_chk_fail();
  }
  return 0;
}
```

This function:

1. Requests input from the user via the C library scanf function.
2. Checks that the user input is greater than 0x21 characters (which is 33 in decimal). If it's less, print out Incorrect and exit the process.  
3. If the input is greater than 33 characters, for every character in the user supplied string pass the character as an argument to another function `FUN_001007fa`. If the result from the function matches the character stored in `&DAT_003014e0` + the index of the loop * `8`, then continue looping through the user supplied characters in the string. If there is a mismatch on any character then exit the process. 

So from this it looks like our input is being checked character by character against another character array in the bss region of memory. For each iteration of the loop we see it multiplied by 8, which means the characters we are checking against are placed at 8 byte offsets from eachother. We can verify this by looking the data stored in `&DAT_003014e0`:

```
                             DAT_003014e0                                    XREF[2]:     FUN_001008a1:0010096b(*),
                                                                                          FUN_001008a1:00100972(*)
        003014e0 01              ??         01h
        003014e1 00              ??         00h
        003014e2 00              ??         00h
        003014e3 00              ??         00h
        003014e4 00              ??         00h
        003014e5 00              ??         00h
        003014e6 00              ??         00h
        003014e7 00              ??         00h
        003014e8 09              ??         09h
        003014e9 00              ??         00h
        003014ea 00              ??         00h
        003014eb 00              ??         00h
        003014ec 00              ??         00h
        003014ed 00              ??         00h
        003014ee 00              ??         00h
        003014ef 00              ??         00h
        003014f0 11              ??         11h
        003014f1 00              ??         00h
        003014f2 00              ??         00h
        003014f3 00              ??         00h
        003014f4 00              ??         00h
        003014f5 00              ??         00h
        003014f6 00              ??         00h
        003014f7 00              ??         00h
        003014f8 27              ??         27h    '
        003014f9 00              ??         00h
        003014fa 00              ??         00h
        003014fb 00              ??         00h
        003014fc 00              ??         00h
        003014fd 00              ??         00h
        003014fe 00              ??         00h
        003014ff 00              ??         00h
        00301500 02              ??         02h
        00301501 00              ??         00h
        00301502 00              ??         00h
        00301503 00              ??         00h
        00301504 00              ??         00h
        00301505 00              ??         00h
        00301506 00              ??         00h
        00301507 00              ??         00h
        00301508 00              ??         00h
        00301509 00              ??         00h
        0030150a 00              ??         00h
        0030150b 00              ??         00h
        0030150c 00              ??         00h
        0030150d 00              ??         00h
        0030150e 00              ??         00h
        0030150f 00              ??         00h
        00301510 12              ??         12h
        00301511 00              ??         00h
        00301512 00              ??         00h
        00301513 00              ??         00h
        00301514 00              ??         00h
        00301515 00              ??         00h
        00301516 00              ??         00h
        00301517 00              ??         00h
        00301518 03              ??         03h
        00301519 00              ??         00h
        0030151a 00              ??         00h
        0030151b 00              ??         00h
        0030151c 00              ??         00h
        0030151d 00              ??         00h
        0030151e 00              ??         00h
        0030151f 00              ??         00h
        00301520 08              ??         08h
        00301521 00              ??         00h
        00301522 00              ??         00h
        00301523 00              ??         00h
        00301524 00              ??         00h
        00301525 00              ??         00h
        00301526 00              ??         00h
        00301527 00              ??         00h
        00301528 12              ??         12h
        00301529 00              ??         00h
        0030152a 00              ??         00h
        0030152b 00              ??         00h
        0030152c 00              ??         00h
        0030152d 00              ??         00h
        0030152e 00              ??         00h
        0030152f 00              ??         00h
        00301530 09              ??         09h
        00301531 00              ??         00h
        00301532 00              ??         00h
        00301533 00              ??         00h
        00301534 00              ??         00h
        00301535 00              ??         00h
        00301536 00              ??         00h
        00301537 00              ??         00h
        00301538 12              ??         12h
        00301539 00              ??         00h
        0030153a 00              ??         00h
        0030153b 00              ??         00h
        0030153c 00              ??         00h
        0030153d 00              ??         00h
        0030153e 00              ??         00h
        0030153f 00              ??         00h
        00301540 11              ??         11h
        00301541 00              ??         00h
        00301542 00              ??         00h
        00301543 00              ??         00h
        00301544 00              ??         00h
        00301545 00              ??         00h
        00301546 00              ??         00h
        00301547 00              ??         00h
        00301548 01              ??         01h
        00301549 00              ??         00h
        0030154a 00              ??         00h
        0030154b 00              ??         00h
        0030154c 00              ??         00h
        0030154d 00              ??         00h
        0030154e 00              ??         00h
        0030154f 00              ??         00h
        00301550 03              ??         03h
        00301551 00              ??         00h
        00301552 00              ??         00h
        00301553 00              ??         00h
        00301554 00              ??         00h
        00301555 00              ??         00h
        00301556 00              ??         00h
        00301557 00              ??         00h
        00301558 13              ??         13h
        00301559 00              ??         00h
        0030155a 00              ??         00h
        0030155b 00              ??         00h
        0030155c 00              ??         00h
        0030155d 00              ??         00h
        0030155e 00              ??         00h
        0030155f 00              ??         00h
        00301560 04              ??         04h
        00301561 00              ??         00h
        00301562 00              ??         00h
        00301563 00              ??         00h
        00301564 00              ??         00h
        00301565 00              ??         00h
        00301566 00              ??         00h
        00301567 00              ??         00h
        00301568 03              ??         03h
        00301569 00              ??         00h
        0030156a 00              ??         00h
        0030156b 00              ??         00h
        0030156c 00              ??         00h
        0030156d 00              ??         00h
        0030156e 00              ??         00h
        0030156f 00              ??         00h
        00301570 05              ??         05h
        00301571 00              ??         00h
        00301572 00              ??         00h
        00301573 00              ??         00h
        00301574 00              ??         00h
        00301575 00              ??         00h
        00301576 00              ??         00h
        00301577 00              ??         00h
        00301578 15              ??         15h
        00301579 00              ??         00h
        0030157a 00              ??         00h
        0030157b 00              ??         00h
        0030157c 00              ??         00h
        0030157d 00              ??         00h
        0030157e 00              ??         00h
        0030157f 00              ??         00h
        00301580 2e              ??         2Eh    .
        00301581 00              ??         00h
        00301582 00              ??         00h
        00301583 00              ??         00h
        00301584 00              ??         00h
        00301585 00              ??         00h
        00301586 00              ??         00h
        00301587 00              ??         00h
        00301588 0a              ??         0Ah
        00301589 00              ??         00h
        0030158a 00              ??         00h
        0030158b 00              ??         00h
        0030158c 00              ??         00h
        0030158d 00              ??         00h
        0030158e 00              ??         00h
        0030158f 00              ??         00h
        00301590 03              ??         03h
        00301591 00              ??         00h
        00301592 00              ??         00h
        00301593 00              ??         00h
        00301594 00              ??         00h
        00301595 00              ??         00h
        00301596 00              ??         00h
        00301597 00              ??         00h
        00301598 0a              ??         0Ah
        00301599 00              ??         00h
        0030159a 00              ??         00h
        0030159b 00              ??         00h
        0030159c 00              ??         00h
        0030159d 00              ??         00h
        0030159e 00              ??         00h
        0030159f 00              ??         00h
        003015a0 12              ??         12h
        003015a1 00              ??         00h
        003015a2 00              ??         00h
        003015a3 00              ??         00h
        003015a4 00              ??         00h
        003015a5 00              ??         00h
        003015a6 00              ??         00h
        003015a7 00              ??         00h
        003015a8 03              ??         03h
        003015a9 00              ??         00h
        003015aa 00              ??         00h
        003015ab 00              ??         00h
        003015ac 00              ??         00h
        003015ad 00              ??         00h
        003015ae 00              ??         00h
        003015af 00              ??         00h
        003015b0 01              ??         01h
        003015b1 00              ??         00h
        003015b2 00              ??         00h
        003015b3 00              ??         00h
        003015b4 00              ??         00h
        003015b5 00              ??         00h
        003015b6 00              ??         00h
        003015b7 00              ??         00h
        003015b8 2e              ??         2Eh    .
        003015b9 00              ??         00h
        003015ba 00              ??         00h
        003015bb 00              ??         00h
        003015bc 00              ??         00h
        003015bd 00              ??         00h
        003015be 00              ??         00h
        003015bf 00              ??         00h
        003015c0 16              ??         16h
        003015c1 00              ??         00h
        003015c2 00              ??         00h
        003015c3 00              ??         00h
        003015c4 00              ??         00h
        003015c5 00              ??         00h
        003015c6 00              ??         00h
        003015c7 00              ??         00h
        003015c8 2e              ??         2Eh    .
        003015c9 00              ??         00h
        003015ca 00              ??         00h
        003015cb 00              ??         00h
        003015cc 00              ??         00h
        003015cd 00              ??         00h
        003015ce 00              ??         00h
        003015cf 00              ??         00h
        003015d0 0a              ??         0Ah
        003015d1 00              ??         00h
        003015d2 00              ??         00h
        003015d3 00              ??         00h
        003015d4 00              ??         00h
        003015d5 00              ??         00h
        003015d6 00              ??         00h
        003015d7 00              ??         00h
        003015d8 12              ??         12h
        003015d9 00              ??         00h
        003015da 00              ??         00h
        003015db 00              ??         00h
        003015dc 00              ??         00h
        003015dd 00              ??         00h
        003015de 00              ??         00h
        003015df 00              ??         00h
        003015e0 06              ??         06h
        003015e1 00              ??         00h
        003015e2 00              ??         00h
        003015e3 00              ??         00h
        003015e4 00              ??         00h
        003015e5 00              ??         00h
        003015e6 00              ??         00h
        003015e7 00              ??         00h
```

As expected we see a number of bytes in the zero initialised memory with offsets of 8 between each character. I gathered all the non-zero bytes and added them to a c style string array:

```c
\x01\x09\x11\x27\x02\x12\x03\x08\x12\x09\x12\x11\x01\x03\x13\x04\x03\x05\x15\x2e\x0a\x03\x0a\x12\x03\x01\x2e\x16\x2e\x0a\x12\x06
```

When a character is passed into `FUN_001007fa`, the result from FUN_001007fa should match the character in the byte array above on its respective iteration. More simply, the input from our first user supplied character string sent to scanf should produce 0x1, and the 2nd 0x09 ... and so on with last character producing 0x06. 

We still do not know what character to send to the function or what the function does. We need to inspect `FUN_001007fa`:

```c
long FUN_001007fa(char param_1)

{
  long local_10;

  local_10 = 0;
  while ((local_10 != -1 && ((int)param_1 != *(int *)(&DAT_00301020 + local_10 * 4)))) {
    if ((int)param_1 < *(int *)(&DAT_00301020 + local_10 * 4)) {
      local_10 = local_10 * 2 + 1;
    }
    else if (*(int *)(&DAT_00301020 + local_10 * 4) < (int)param_1) {
      local_10 = (local_10 + 1) * 2;
    }
  }
  return local_10;
}
```

From this function we see:

1. It takes 1 character as input. 
2. Uses a while loop with a condition that the index must not be `-1` and input character is not equal to the character stored at `&DAT_00301020` + the index * 4. 
3. If the character is less than stored character then the index will = the index * 2 + 1
4. If the charater is less than the stored character, then the index will = the (index + 1) * 2. 
5. If the user supplied character is equal to the character stored at `&DAT_00301020` + the index * 4, then the funtion returns the index. 

This means whatever character we supply,  when it matches the character stored at the `&DAT_00301020` array, it will return the index, and the index will be checked against the other character array previously mentioned. This was slightly confusing to me at first, but if we think of an example using the first character, we know that the result needs to be 0x1. So with that in mind, if we say the index is 1, then `&DAT_00301020` + (1 * 4) would take us to the array's offset of `&DAT_00301024`. 

We can verify this by looking at the contents stored in `&DAT_00301020`:

```
                             DAT_00301020                                    XREF[6]:     FUN_001007fa:00100820(*),
                                                                                          FUN_001007fa:00100827(*),
                                                                                          FUN_001007fa:00100844(*),
                                                                                          FUN_001007fa:0010084b(*),
                                                                                          FUN_001007fa:00100873(*),
                                                                                          FUN_001007fa:0010087a(*)
        00301020 77              ??         77h    w
        00301021 00              ??         00h
        00301022 00              ??         00h
        00301023 00              ??         00h
        00301024 66              ??         66h    f
        00301025 00              ??         00h
        00301026 00              ??         00h
        00301027 00              ??         00h
        00301028 7b              ??         7Bh    {
        00301029 00              ??         00h
        0030102a 00              ??         00h
        0030102b 00              ??         00h
        0030102c 5f              ??         5Fh    _
        0030102d 00              ??         00h
        0030102e 00              ??         00h
        0030102f 00              ??         00h
        00301030 6e              ??         6Eh    n
        00301031 00              ??         00h
        00301032 00              ??         00h
        00301033 00              ??         00h
        00301034 79              ??         79h    y
        00301035 00              ??         00h
        00301036 00              ??         00h
        00301037 00              ??         00h
        00301038 7d              ??         7Dh    }
        00301039 00              ??         00h
        0030103a 00              ??         00h
        0030103b 00              ??         00h
        0030103c ff              ??         FFh
        0030103d ff              ??         FFh
        0030103e ff              ??         FFh
        0030103f ff              ??         FFh
        00301040 62              ??         62h    b
        00301041 00              ??         00h
        00301042 00              ??         00h
        00301043 00              ??         00h
        00301044 6c              ??         6Ch    l
        00301045 00              ??         00h
        00301046 00              ??         00h
        00301047 00              ??         00h
        00301048 72              ??         72h    r
        00301049 00              ??         00h
        0030104a 00              ??         00h
        0030104b 00              ??         00h
        0030104c ff              ??         FFh
        0030104d ff              ??         FFh
        0030104e ff              ??         FFh
        0030104f ff              ??         FFh
        00301050 ff              ??         FFh
        00301051 ff              ??         FFh
        00301052 ff              ??         FFh
        00301053 ff              ??         FFh
        00301054 ff              ??         FFh
        00301055 ff              ??         FFh
        00301056 ff              ??         FFh
        00301057 ff              ??         FFh
        00301058 ff              ??         FFh
        00301059 ff              ??         FFh
        0030105a ff              ??         FFh
        0030105b ff              ??         FFh
        0030105c ff              ??         FFh
        0030105d ff              ??         FFh
        0030105e ff              ??         FFh
        0030105f ff              ??         FFh
        00301060 ff              ??         FFh
        00301061 ff              ??         FFh
        00301062 ff              ??         FFh
        00301063 ff              ??         FFh
        00301064 61              ??         61h    a
        00301065 00              ??         00h
        00301066 00              ??         00h
        00301067 00              ??         00h
        00301068 65              ??         65h    e
        00301069 00              ??         00h
        0030106a 00              ??         00h
        0030106b 00              ??         00h
        0030106c 69              ??         69h    i
        0030106d 00              ??         00h
        0030106e 00              ??         00h
        0030106f 00              ??         00h
        00301070 ff              ??         FFh
        00301071 ff              ??         FFh
        00301072 ff              ??         FFh
        00301073 ff              ??         FFh
        00301074 6f              ??         6Fh    o
        00301075 00              ??         00h
        00301076 00              ??         00h
        00301077 00              ??         00h
        00301078 74              ??         74h    t
        00301079 00              ??         00h
        0030107a 00              ??         00h
        0030107b 00              ??         00h
        0030107c ff              ??         FFh
        0030107d ff              ??         FFh
        0030107e ff              ??         FFh
        0030107f ff              ??         FFh
        00301080 ff              ??         FFh
        00301081 ff              ??         FFh
        00301082 ff              ??         FFh
        00301083 ff              ??         FFh
        00301084 ff              ??         FFh
        00301085 ff              ??         FFh
        00301086 ff              ??         FFh
        00301087 ff              ??         FFh
        00301088 ff              ??         FFh
        00301089 ff              ??         FFh
        0030108a ff              ??         FFh
        0030108b ff              ??         FFh
        0030108c ff              ??         FFh
        0030108d ff              ??         FFh
        0030108e ff              ??         FFh
        0030108f ff              ??         FFh
        00301090 ff              ??         FFh
        00301091 ff              ??         FFh
        00301092 ff              ??         FFh
        00301093 ff              ??         FFh
        00301094 ff              ??         FFh
        00301095 ff              ??         FFh
        00301096 ff              ??         FFh
        00301097 ff              ??         FFh
        00301098 ff              ??         FFh
        00301099 ff              ??         FFh
        0030109a ff              ??         FFh
        0030109b ff              ??         FFh
        0030109c ff              ??         FFh
        0030109d ff              ??         FFh
        0030109e ff              ??         FFh
        0030109f ff              ??         FFh
        003010a0 ff              ??         FFh
        003010a1 ff              ??         FFh
        003010a2 ff              ??         FFh
        003010a3 ff              ??         FFh
        003010a4 ff              ??         FFh
        003010a5 ff              ??         FFh
        003010a6 ff              ??         FFh
        003010a7 ff              ??         FFh
        003010a8 ff              ??         FFh
        003010a9 ff              ??         FFh
        003010aa ff              ??         FFh
        003010ab ff              ??         FFh
        003010ac ff              ??         FFh
        003010ad ff              ??         FFh
        003010ae ff              ??         FFh
        003010af ff              ??         FFh
        003010b0 ff              ??         FFh
        003010b1 ff              ??         FFh
        003010b2 ff              ??         FFh
        003010b3 ff              ??         FFh
        003010b4 ff              ??         FFh
        003010b5 ff              ??         FFh
        003010b6 ff              ??         FFh
        003010b7 ff              ??         FFh
        003010b8 ff              ??         FFh
        003010b9 ff              ??         FFh
        003010ba ff              ??         FFh
        003010bb ff              ??         FFh
        003010bc 67              ??         67h    g
        003010bd 00              ??         00h
        003010be 00              ??         00h
        003010bf 00              ??         00h
        003010c0 ff              ??         FFh
        003010c1 ff              ??         FFh
        003010c2 ff              ??         FFh
        003010c3 ff              ??         FFh
        003010c4 ff              ??         FFh
        003010c5 ff              ??         FFh
        003010c6 ff              ??         FFh
        003010c7 ff              ??         FFh
        003010c8 ff              ??         FFh
        003010c9 ff              ??         FFh
        003010ca ff              ??         FFh
        003010cb ff              ??         FFh
        003010cc ff              ??         FFh
        003010cd ff              ??         FFh
        003010ce ff              ??         FFh
        003010cf ff              ??         FFh
        003010d0 ff              ??         FFh
        003010d1 ff              ??         FFh
        003010d2 ff              ??         FFh
        003010d3 ff              ??         FFh
        003010d4 ff              ??         FFh
        003010d5 ff              ??         FFh
        003010d6 ff              ??         FFh
        003010d7 ff              ??         FFh
        003010d8 75              ??         75h    u
```

Looking at this section, we see that the offset 00301024 maps to the letter `f`:

```
00301024 66              ??         66h    f
```

This is the first character we need to enter.  For the second character we know the index needs to result in 0x9, and 9 * (the offset of 4) is 36 or 0x24 in hex. So we can expect `00301044` to hold the letter for our 2nd character. 

```
00301044 6c              ??         6Ch    l
```

This maps to the letter `l`. It looks like we have identified how to get the input for all the letters. 
