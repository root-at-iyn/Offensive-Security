#include <stdio.h>
#include <stdlib.h>
#include <string.h>


valid_serial(char buffer[], int ser) {
   int i = 0;
   char ** x;
   unsigned int serialOut = 0;

    for (i=0; i <=4095; i++) {
        // serialOut += (unsigned long int)(&buffer);
        x = buffer + (i % strlen(buffer));
        printf("DEBUG: Address of Name buffer = %p\n", buffer);
        printf("DEBUG: value of the first byte of (buffer: %p + remainder: %lu) = %p\n", 
                buffer, (i % strlen(buffer)) , (((long long)(*x)) >> (8*8)) & 0xff );

        // The statement below does the following:
        // Convert the pointer to a long long (64-bit) value and derefernce x (get the value in x which is a pointer)
        // Shift the dereferenced x pointer value right by 8 bytes to get the first byte (in little endian)
        // Add the first byte to the serialOut variable (which will be compared to )  
        serialOut += (((long long)(*x)) >> (8*8)) & 0xff ; 
   }
   
   printf("The value of serialOut = %u\n", serialOut); 

   return serialOut == ser;
}


int main()
{
    char buffer[64] = {};
    unsigned int serial;

    printf("------------------------------------------------------------\n");
    printf("--[ Reverse Engineering Level #1 - Serial Crackme           \n");
    printf("------------------------------------------------------------\n");

    // prompt the user for their name
    printf("Enter your name: ");
    fgets(buffer, sizeof(buffer), stdin);
    buffer[strcspn(buffer, "\n")] = 0;     // strip newline

    // if no name was given, abort
    if(strlen(buffer) == 0)
    {
        printf("Invalid name...\n");
        exit(1);
    }

    // prompt the user for a valid serial number
    printf("Enter serial number: ");
    scanf("%u", &serial);
    printf("------------------------------------------------------------\n");

    // check the serial number for correctness
    if(!valid_serial(buffer, serial))
    {
        printf("Invalid serial number...\n");
        exit(1);
    }

    printf("Serial number accepted!\n");
    system("cat flag");

}


